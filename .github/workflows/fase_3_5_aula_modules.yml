name: ğŸ§© Terraform Modules

on:
  push:
    branches: [ modules ]

jobs:
  deploy:
    name: ğŸ—ï¸ Deploy com MÃ³dulos
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: ğŸ”‘ Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: âœ… Validate Modules
        run: |
          for module in fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/modules/*/; do
            echo "ğŸ“¦ Validando $module"
            cd $module
            terraform init -backend=false
            terraform validate
            cd - > /dev/null
          done
      
      - name: âš™ï¸ Init
        working-directory: fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/environments/modules
        run: terraform init
      
      - name: ğŸ“‹ Plan
        working-directory: fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/environments/modules
        run: terraform plan -out=tfplan
      
      - name: ğŸš€ Apply
        working-directory: fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/environments/modules
        run: terraform apply -auto-approve tfplan
