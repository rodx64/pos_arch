name: ðŸ—ï¸ Terraform CI/CD

on:
  push:
    branches: [ pos/* ]
    paths: [ 'fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/**' ]

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0
  WORKING_DIR: fase_3/aulas/1_ci_cd/hands_on/5_aula/terraform/environments/development

jobs:
  terraform-deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: ðŸ”‘ Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ðŸŽ¯ Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform fmt -check -recursive
      
      - name: âš™ï¸ Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init
      
      - name: âœ… Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate
      
      - name: ðŸ“‹ Plan
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform plan -out=tfplan
      
      - name: ðŸš€ Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan
      
      - name: ðŸ“Š Output
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
