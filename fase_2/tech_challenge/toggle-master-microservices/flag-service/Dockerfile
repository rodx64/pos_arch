# ==========================
# üèóÔ∏è STAGE 1 ‚Äî Builder
# ==========================
# Este est√°gio monta um ambiente tempor√°rio para COMPILAR e INSTALAR as depend√™ncias da aplica√ß√£o.
# Ele inclui ferramentas pesadas como gcc e build-essential, necess√°rias apenas para build.
# O resultado √© uma pasta /install contendo todos os pacotes Python j√° prontos (sem cache e sem lixo de build).
# Este est√°gio N√ÉO vira um container execut√°vel ‚Äî ele serve apenas de base para o est√°gio final.
FROM python:3.11-slim AS builder

# Define diret√≥rio de trabalho
WORKDIR /app

# Evita gera√ß√£o de arquivos .pyc e ativa logs diretos no terminal
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Instala depend√™ncias de compila√ß√£o tempor√°rias
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copia depend√™ncias do projeto
COPY requirements.txt .

# Instala depend√™ncias Python no diret√≥rio isolado /install
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt


# ==========================
# üßπ Docker descarta o container do builder (ele n√£o vai para a imagem final)
# ==========================


# ==========================
# üß© STAGE 2 ‚Äî Runtime final
# ==========================
# Este √© o container final e leve, usado em execu√ß√£o (ex: docker compose up flag-service)
# Ele cont√©m apenas o Python, as depend√™ncias prontas e o c√≥digo-fonte da aplica√ß√£o.
FROM python:3.11-slim AS runtime

# Define diret√≥rio de trabalho
WORKDIR /app

# Instala apenas o curl (necess√°rio para healthcheck)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copia as depend√™ncias j√° instaladas no builder (sem o ambiente pesado)
COPY --from=builder /install /usr/local

# Copia o c√≥digo da aplica√ß√£o
COPY . .

# Exp√µe a porta do Flask (ou Gunicorn)
EXPOSE 5000

# Define o comando padr√£o (executa o app)
CMD ["python", "app.py"]
