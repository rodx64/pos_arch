# ==========================
# ğŸ—ï¸ STAGE 1 â€” Builder
# ==========================
# Este estÃ¡gio monta um ambiente temporÃ¡rio para COMPILAR e INSTALAR as dependÃªncias da aplicaÃ§Ã£o.
# Ele inclui ferramentas pesadas como gcc e build-essential, necessÃ¡rias apenas para build.
# O resultado Ã© uma pasta /install contendo todos os pacotes Python jÃ¡ prontos (sem cache e sem lixo de build).
# Este estÃ¡gio NÃƒO vira um container executÃ¡vel â€” ele serve apenas de base para o estÃ¡gio final.
FROM python:3.11-slim AS builder

# Define diretÃ³rio de trabalho
WORKDIR /app

# Evita geraÃ§Ã£o de arquivos .pyc e ativa logs diretos no terminal
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Instala dependÃªncias de compilaÃ§Ã£o temporÃ¡rias
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copia dependÃªncias do projeto
COPY requirements.txt .

# Instala dependÃªncias Python no diretÃ³rio isolado /install
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt


# ==========================
# ğŸ§¹ Docker descarta o container do builder (ele nÃ£o vai para a imagem final)
# ==========================


# ==========================
# ğŸ§© STAGE 2 â€” Runtime final
# ==========================
# Este Ã© o container final e leve, usado em execuÃ§Ã£o (ex: docker compose up analytics-service)
# Ele contÃ©m apenas o Python, as dependÃªncias prontas e o cÃ³digo-fonte da aplicaÃ§Ã£o.
FROM python:3.11-alpine AS runtime

# Define diretÃ³rio de trabalho
WORKDIR /app

# Copia as dependÃªncias jÃ¡ instaladas no builder (sem o ambiente pesado)
COPY --from=builder /install /usr/local

# Copia o cÃ³digo da aplicaÃ§Ã£o
COPY . .

# ExpÃµe a porta do Flask (ou Gunicorn)
EXPOSE 5000

# Define o comando padrÃ£o (executa o app)
CMD ["python", "app.py"]
